<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Pebblous Blog</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="/styles/tailwind-build.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #f8fafc;
        }
        .accent-bg { background-color: #F86825; }
        .accent-color { color: #F86825; }
        .accent-border { border-color: #F86825; }
        .btn-primary {
            background-color: #F86825;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary {
            background-color: #64748b;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        .btn-secondary:hover { opacity: 0.9; }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-published { background-color: #10b981; color: white; }
        .badge-draft { background-color: #f59e0b; color: white; }
        .badge-featured { background-color: #8b5cf6; color: white; }

        /* Login Screen */
        #login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #020617 0%, #1e293b 100%);
        }
        #admin-content {
            display: none;
        }
        #admin-content.authenticated {
            display: block;
        }
        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 100%;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-box">
            <div class="text-center mb-8">
                <img src="https://pebblous.github.io/image/Pebblous_BM_Orange_RGB.png" alt="Pebblous Logo" class="h-12 mx-auto mb-4">
                <h1 class="text-2xl font-bold text-slate-800">Admin Login</h1>
                <p class="text-sm text-slate-600 mt-2">ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</p>
            </div>
            <form id="login-form" onsubmit="return handleLogin(event)">
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-slate-700 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                    <input
                        type="password"
                        id="password"
                        autocomplete="current-password"
                        class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                        placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                        required
                    >
                </div>
                <button type="submit" class="w-full btn-primary py-3 text-lg">ë¡œê·¸ì¸</button>
                <p id="login-error" class="text-red-600 text-sm mt-3 hidden">ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.</p>
            </form>
            <div class="mt-6 pt-6 border-t border-slate-200">
                <p class="text-xs text-slate-500 text-center">
                    ì„¸ì…˜ì€ 24ì‹œê°„ ìœ ì§€ë©ë‹ˆë‹¤
                </p>
            </div>
        </div>
    </div>

    <!-- Admin Content (Hidden until authenticated) -->
    <div id="admin-content">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-slate-200">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img src="https://pebblous.github.io/image/Pebblous_BM_Orange_RGB.png" alt="Pebblous Logo" class="h-8">
                    <h1 class="text-2xl font-bold text-slate-800">Blog Admin</h1>
                </div>
                <div class="flex items-center gap-4">
                    <a href="/" target="_blank" class="text-sm text-slate-600 hover:text-slate-900">ë¸”ë¡œê·¸ ë³´ê¸° â†’</a>
                    <button onclick="logout()" class="text-sm text-slate-600 hover:text-slate-900">ë¡œê·¸ì•„ì›ƒ</button>
                    <button onclick="saveChanges()" class="btn-primary">ë³€ê²½ì‚¬í•­ ì €ì¥</button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                <h3 class="text-sm font-medium text-slate-600">Total Articles</h3>
                <p id="stat-total" class="text-3xl font-bold text-slate-900 mt-2">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                <h3 class="text-sm font-medium text-slate-600">Published</h3>
                <p id="stat-published" class="text-3xl font-bold text-green-600 mt-2">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                <h3 class="text-sm font-medium text-slate-600">Drafts</h3>
                <p id="stat-drafts" class="text-3xl font-bold text-orange-600 mt-2">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                <h3 class="text-sm font-medium text-slate-600">Featured</h3>
                <p id="stat-featured" class="text-3xl font-bold text-purple-600 mt-2">0</p>
            </div>
        </div>

        <!-- Actions -->
        <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 mb-8">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Quick Actions</h2>
            <div class="flex flex-wrap gap-3">
                <button onclick="showAddArticleForm()" class="btn-primary">+ ìƒˆ ê¸°ì‚¬ ì¶”ê°€</button>
                <button onclick="refreshData()" class="btn-secondary">âŸ³ ìƒˆë¡œê³ ì¹¨</button>
                <button onclick="exportJSON()" class="btn-secondary">â†“ JSON ë‹¤ìš´ë¡œë“œ</button>
                <button onclick="showUnregisteredFiles()" class="btn-secondary">ğŸ“‹ ë¯¸ë“±ë¡ íŒŒì¼ ë³´ê¸°</button>
            </div>
        </div>

        <!-- Filters & Search -->
        <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 mb-8">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Filter & Search</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">ê²€ìƒ‰</label>
                    <input type="text" id="search-articles" placeholder="ì œëª©, IDë¡œ ê²€ìƒ‰..." class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">ì¹´í…Œê³ ë¦¬</label>
                    <select id="filter-category" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <option value="all">ì „ì²´</option>
                        <option value="art">Data Art</option>
                        <option value="tech">Tech Insights</option>
                        <option value="story">Data Stories</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">ìƒíƒœ</label>
                    <select id="filter-status" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <option value="all">ì „ì²´</option>
                        <option value="published">Published</option>
                        <option value="draft">Draft</option>
                        <option value="featured">Featured</option>
                        <option value="unregistered">ë¯¸ë“±ë¡ íŒŒì¼</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">ì •ë ¬</label>
                    <select id="sort-by" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <option value="date-desc">ë‚ ì§œ (ìµœì‹ ìˆœ)</option>
                        <option value="date-asc">ë‚ ì§œ (ì˜¤ë˜ëœìˆœ)</option>
                        <option value="title-asc">ì œëª© (A-Z)</option>
                        <option value="title-desc">ì œëª© (Z-A)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Add Article Form (Hidden by default) -->
        <div id="add-article-form" class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 mb-8 hidden">
            <h2 class="text-xl font-bold text-slate-800 mb-4">ìƒˆ ê¸°ì‚¬ ì¶”ê°€</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">ID (ê³ ìœ ê°’)</label>
                    <input type="text" id="new-id" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="article-slug-2025">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">ì œëª©</label>
                    <input type="text" id="new-title" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="ê¸°ì‚¬ ì œëª©">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-2">ì„¤ëª…</label>
                    <textarea id="new-description" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="ê¸°ì‚¬ ì„¤ëª…"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">ì¹´í…Œê³ ë¦¬</label>
                    <select id="new-category" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <option value="art">Data Art</option>
                        <option value="tech">Tech Insights</option>
                        <option value="story">Data Stories</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">ë‚ ì§œ</label>
                    <input type="date" id="new-date" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">ê²½ë¡œ (Path)</label>
                    <input type="text" id="new-path" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="report/article-name/index.html">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">ì´ë¯¸ì§€ URL</label>
                    <input type="text" id="new-image" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="https://...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                    <input type="text" id="new-tags" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Tag1, Tag2, Tag3">
                </div>
                <div class="flex items-center gap-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="new-published" checked class="mr-2">
                        <span class="text-sm font-medium text-slate-700">ë°œê°„</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="new-featured" class="mr-2">
                        <span class="text-sm font-medium text-slate-700">Featured</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="new-external" class="mr-2">
                        <span class="text-sm font-medium text-slate-700">ì™¸ë¶€ ë§í¬</span>
                    </label>
                </div>
            </div>
            <div class="mt-6 flex gap-3">
                <button onclick="addArticle()" class="btn-primary">ì¶”ê°€í•˜ê¸°</button>
                <button onclick="hideAddArticleForm()" class="btn-secondary">ì·¨ì†Œ</button>
            </div>
        </div>

        <!-- Articles Table -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 border-b border-slate-200">
                <h2 class="text-xl font-bold text-slate-800">Articles</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ì œëª© & ê²½ë¡œ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ì¹´í…Œê³ ë¦¬</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ë‚ ì§œ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ìƒíƒœ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="articles-table-body" class="bg-white divide-y divide-slate-200">
                        <tr>
                            <td colspan="5" class="px-6 py-10 text-center text-slate-500">
                                Loading articles...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    </div>
    <!-- End Admin Content -->

    <script>
        let articlesData = { articles: [], categories: {} };
        let hasUnsavedChanges = false;
        let unregisteredFiles = [];
        let htmlMetadataCache = {};

        // Load articles.json and files-index.json
        async function loadArticles() {
            try {
                const response = await fetch('articles.json', { cache: 'no-store' });
                articlesData = await response.json();

                // Load unregistered files
                await loadUnregisteredFiles();

                renderTable();
                updateStats();
            } catch (error) {
                console.error('Failed to load articles:', error);
                alert('ê¸°ì‚¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function loadUnregisteredFiles() {
            try {
                const response = await fetch('files-index.json', { cache: 'no-store' });
                const data = await response.json();

                // Get all registered paths from articles.json
                const registeredPaths = new Set(
                    articlesData.articles.map(a => a.path.trim())
                );

                // Filter out files that are already registered
                unregisteredFiles = data.files.filter(f => {
                    return !f.registered && !registeredPaths.has(f.path.trim());
                });

                // Extract metadata from HTML files
                for (const file of unregisteredFiles) {
                    await extractHTMLMetadata(file.path);
                }
            } catch (error) {
                console.warn('files-index.json not found. Run: python3 scan-html-files.py');
                unregisteredFiles = [];
            }
        }

        async function extractHTMLMetadata(path) {
            if (htmlMetadataCache[path]) return htmlMetadataCache[path];

            try {
                const response = await fetch('/' + path);
                const html = await response.text();

                // Parse HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Extract metadata
                const metadata = {
                    title: doc.querySelector('title')?.textContent ||
                           doc.querySelector('meta[property="og:title"]')?.content ||
                           path.split('/').pop(),
                    description: doc.querySelector('meta[name="description"]')?.content ||
                                doc.querySelector('meta[property="og:description"]')?.content ||
                                '',
                    keywords: doc.querySelector('meta[name="keywords"]')?.content || '',
                    image: doc.querySelector('meta[property="og:image"]')?.content ||
                           doc.querySelector('meta[name="twitter:image"]')?.content ||
                           ''
                };

                htmlMetadataCache[path] = metadata;
                return metadata;
            } catch (error) {
                console.warn(`Failed to fetch metadata for ${path}:`, error);
                return {
                    title: path.split('/').pop(),
                    description: '',
                    keywords: '',
                    image: ''
                };
            }
        }

        function updateStats() {
            const total = articlesData.articles.length + unregisteredFiles.length;
            const published = articlesData.articles.filter(a => a.published).length;
            const drafts = articlesData.articles.filter(a => !a.published).length + unregisteredFiles.length;
            const featured = articlesData.articles.filter(a => a.featured).length;

            document.getElementById('stat-total').textContent = `${articlesData.articles.length} + ${unregisteredFiles.length} ë¯¸ë“±ë¡`;
            document.getElementById('stat-published').textContent = published;
            document.getElementById('stat-drafts').textContent = drafts;
            document.getElementById('stat-featured').textContent = featured;
        }

        function renderTable() {
            const tbody = document.getElementById('articles-table-body');
            let items = getFilteredAndSortedArticles();

            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-slate-500">No articles found.</td></tr>';
                return;
            }

            tbody.innerHTML = items.map((item, displayIndex) => {
                // Check if this is an unregistered file
                const isUnregistered = item.isUnregistered;

                if (isUnregistered) {
                    // Render unregistered file row
                    const metadata = htmlMetadataCache[item.path] || {};
                    const pathParts = item.path.split('/');
                    const filename = pathParts[pathParts.length - 1];
                    const folder = pathParts.slice(0, -1).join('/');

                    return `
                        <tr class="hover:bg-orange-50 bg-orange-50/30">
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2">
                                    <span class="badge bg-orange-500 text-white text-xs px-2 py-1 rounded">ë¯¸ë“±ë¡</span>
                                    <div class="font-medium text-slate-900">${metadata.title || filename}</div>
                                </div>
                                <div class="text-xs text-slate-600 mt-1">${metadata.description || 'ì„¤ëª… ì—†ìŒ'}</div>
                                ${metadata.keywords ? `<div class="text-xs text-slate-500 mt-1">í‚¤ì›Œë“œ: ${metadata.keywords}</div>` : ''}
                                <div class="text-xs text-slate-600 mt-2 flex items-center gap-2">
                                    <span class="text-slate-400">${folder}/</span>
                                    <span class="font-semibold">${filename}</span>
                                    <button onclick="copyPath('${item.path}')" class="text-blue-500 hover:text-blue-700" title="ê²½ë¡œ ë³µì‚¬">
                                        ğŸ“‹
                                    </button>
                                    <a href="/${item.path}" target="_blank" class="text-green-500 hover:text-green-700" title="ë¯¸ë¦¬ë³´ê¸°">
                                        ğŸ‘ï¸
                                    </a>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-sm text-slate-500">-</td>
                            <td class="px-6 py-4 text-sm text-slate-500">-</td>
                            <td class="px-6 py-4">
                                <span class="badge badge-draft">Unregistered</span>
                            </td>
                            <td class="px-6 py-4">
                                <button onclick="registerFile('${item.path}')" class="text-xs bg-orange-500 text-white px-3 py-2 rounded hover:bg-orange-600">
                                    ğŸ“ ë“±ë¡í•˜ê¸°
                                </button>
                            </td>
                        </tr>
                    `;
                }

                // Render registered article row
                const originalIndex = articlesData.articles.findIndex(a => a.id === item.id);

                const categoryBadge = {
                    'art': 'Data Art',
                    'tech': 'Tech Insights',
                    'story': 'Data Stories'
                }[item.category] || item.category;

                const statusBadges = [
                    item.published ? '<span class="badge badge-published">Published</span>' : '<span class="badge badge-draft">Draft</span>',
                    item.featured ? '<span class="badge badge-featured ml-1">Featured</span>' : ''
                ].join('');

                // Get filename from path
                const pathParts = item.path.split('/');
                const filename = pathParts[pathParts.length - 1];
                const folder = pathParts.slice(0, -1).join('/');

                return `
                    <tr class="hover:bg-slate-50">
                        <td class="px-6 py-4">
                            <div class="font-medium text-slate-900">${item.title}</div>
                            <div class="text-xs text-slate-500 mt-1">
                                <span class="font-mono bg-slate-100 px-2 py-1 rounded">ID: ${item.id}</span>
                            </div>
                            <div class="text-xs text-slate-600 mt-2 flex items-center gap-2">
                                <span class="text-slate-400">${folder}/</span>
                                <span class="font-semibold">${filename}</span>
                                <button onclick="copyPath('${item.path}')" class="text-blue-500 hover:text-blue-700" title="ê²½ë¡œ ë³µì‚¬">
                                    ğŸ“‹
                                </button>
                                <a href="/${item.path}" target="_blank" class="text-green-500 hover:text-green-700" title="ë¯¸ë¦¬ë³´ê¸°">
                                    ğŸ‘ï¸
                                </a>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-700">${categoryBadge}</td>
                        <td class="px-6 py-4 text-sm text-slate-700">${item.date}</td>
                        <td class="px-6 py-4">${statusBadges}</td>
                        <td class="px-6 py-4">
                            <div class="flex flex-col gap-2">
                                <div class="flex gap-2">
                                    <button onclick="togglePublish(${originalIndex})" class="text-xs text-blue-600 hover:text-blue-800">
                                        ${item.published ? 'ë¹„ê³µê°œ' : 'ë°œê°„'}
                                    </button>
                                    <button onclick="toggleFeatured(${originalIndex})" class="text-xs text-purple-600 hover:text-purple-800">
                                        ${item.featured ? 'Unfeature' : 'Feature'}
                                    </button>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="duplicateArticle(${originalIndex})" class="text-xs text-green-600 hover:text-green-800">
                                        ë³µì œ
                                    </button>
                                    <button onclick="deleteArticle(${originalIndex})" class="text-xs text-red-600 hover:text-red-800">
                                        ì‚­ì œ
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getFilteredAndSortedArticles() {
            // Combine registered articles and unregistered files
            let items = [...articlesData.articles];

            // Add unregistered files with a flag
            const unregisteredItems = unregisteredFiles.map(file => {
                const metadata = htmlMetadataCache[file.path] || {};
                return {
                    isUnregistered: true,
                    path: file.path,
                    title: metadata.title || file.path.split('/').pop(),
                    description: metadata.description || '',
                    keywords: metadata.keywords || '',
                    image: metadata.image || '',
                    date: '', // No date for unregistered
                    category: '',
                    published: false,
                    featured: false
                };
            });

            items = [...items, ...unregisteredItems];

            // Apply search filter
            const searchTerm = document.getElementById('search-articles')?.value.toLowerCase() || '';
            if (searchTerm) {
                items = items.filter(item => {
                    if (item.isUnregistered) {
                        return item.title.toLowerCase().includes(searchTerm) ||
                               item.path.toLowerCase().includes(searchTerm) ||
                               (item.description && item.description.toLowerCase().includes(searchTerm)) ||
                               (item.keywords && item.keywords.toLowerCase().includes(searchTerm));
                    } else {
                        return item.title.toLowerCase().includes(searchTerm) ||
                               item.id.toLowerCase().includes(searchTerm) ||
                               item.path.toLowerCase().includes(searchTerm);
                    }
                });
            }

            // Apply category filter (only for registered articles)
            const categoryFilter = document.getElementById('filter-category')?.value || 'all';
            if (categoryFilter !== 'all') {
                items = items.filter(item => !item.isUnregistered && item.category === categoryFilter);
            }

            // Apply status filter
            const statusFilter = document.getElementById('filter-status')?.value || 'all';
            if (statusFilter === 'published') {
                items = items.filter(item => !item.isUnregistered && item.published);
            } else if (statusFilter === 'draft') {
                items = items.filter(item => item.isUnregistered || !item.published);
            } else if (statusFilter === 'featured') {
                items = items.filter(item => !item.isUnregistered && item.featured);
            } else if (statusFilter === 'unregistered') {
                items = items.filter(item => item.isUnregistered);
            }

            // Apply sorting
            const sortBy = document.getElementById('sort-by')?.value || 'date-desc';
            switch (sortBy) {
                case 'date-desc':
                    items.sort((a, b) => {
                        if (a.isUnregistered && b.isUnregistered) return 0;
                        if (a.isUnregistered) return 1; // Push unregistered to end
                        if (b.isUnregistered) return -1;
                        return new Date(b.date) - new Date(a.date);
                    });
                    break;
                case 'date-asc':
                    items.sort((a, b) => {
                        if (a.isUnregistered && b.isUnregistered) return 0;
                        if (a.isUnregistered) return 1;
                        if (b.isUnregistered) return -1;
                        return new Date(a.date) - new Date(b.date);
                    });
                    break;
                case 'title-asc':
                    items.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'title-desc':
                    items.sort((a, b) => b.title.localeCompare(a.title));
                    break;
            }

            return items;
        }

        function togglePublish(index) {
            articlesData.articles[index].published = !articlesData.articles[index].published;
            hasUnsavedChanges = true;
            renderTable();
            updateStats();
        }

        function toggleFeatured(index) {
            articlesData.articles[index].featured = !articlesData.articles[index].featured;
            hasUnsavedChanges = true;
            renderTable();
            updateStats();
        }

        function copyPath(path) {
            navigator.clipboard.writeText(path).then(() => {
                alert(`ê²½ë¡œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤:\n${path}`);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('ë³µì‚¬ ì‹¤íŒ¨');
            });
        }

        function duplicateArticle(index) {
            const original = articlesData.articles[index];
            const newArticle = {
                ...original,
                id: `${original.id}-copy-${Date.now()}`,
                title: `${original.title} (ë³µì‚¬ë³¸)`,
                published: false,
                featured: false
            };

            articlesData.articles.push(newArticle);
            hasUnsavedChanges = true;
            renderTable();
            updateStats();
            alert(`ê¸°ì‚¬ê°€ ë³µì œë˜ì—ˆìŠµë‹ˆë‹¤:\nìƒˆ ID: ${newArticle.id}`);
        }

        async function showUnregisteredFiles() {
            try {
                const response = await fetch('files-index.json');
                const data = await response.json();

                const unregistered = data.files.filter(f => !f.registered);

                if (unregistered.length === 0) {
                    alert('ëª¨ë“  HTML íŒŒì¼ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    return;
                }

                let message = `ë¯¸ë“±ë¡ HTML íŒŒì¼ (${unregistered.length}ê°œ):\n\n`;
                unregistered.forEach(f => {
                    message += `â€¢ ${f.path}\n`;
                });
                message += '\nì´ íŒŒì¼ë“¤ì„ articles.jsonì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';

                if (confirm(message)) {
                    // TODO: Auto-populate form with first unregistered file
                    showAddArticleForm();
                    alert('ìƒˆ ê¸°ì‚¬ ì¶”ê°€ í¼ì´ ì—´ë ¸ìŠµë‹ˆë‹¤. ë¯¸ë“±ë¡ íŒŒì¼ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                }
            } catch (error) {
                console.error('Failed to load files-index.json:', error);
                alert('files-index.jsonì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € "python3 scan-html-files.py"ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.');
            }
        }

        // Setup filter/search event listeners
        function setupFilters() {
            ['search-articles', 'filter-category', 'filter-status', 'sort-by'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', renderTable);
                    el.addEventListener('input', renderTable);
                }
            });
        }

        function deleteArticle(index) {
            if (!confirm('ì •ë§ ì´ ê¸°ì‚¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            articlesData.articles.splice(index, 1);
            hasUnsavedChanges = true;
            renderTable();
            updateStats();
        }

        function showAddArticleForm() {
            document.getElementById('add-article-form').classList.remove('hidden');
            // Set today's date as default
            document.getElementById('new-date').valueAsDate = new Date();
        }

        function hideAddArticleForm() {
            document.getElementById('add-article-form').classList.add('hidden');
            // Clear form
            ['new-id', 'new-title', 'new-description', 'new-path', 'new-image', 'new-tags'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('new-published').checked = true;
            document.getElementById('new-featured').checked = false;
            document.getElementById('new-external').checked = false;
        }

        function addArticle() {
            const newArticle = {
                id: document.getElementById('new-id').value.trim(),
                title: document.getElementById('new-title').value.trim(),
                description: document.getElementById('new-description').value.trim(),
                category: document.getElementById('new-category').value,
                date: document.getElementById('new-date').value,
                path: document.getElementById('new-path').value.trim(),
                image: document.getElementById('new-image').value.trim() || 'https://blog.pebblous.ai/image/Pebblous_BM_Orange_RGB.png',
                published: document.getElementById('new-published').checked,
                featured: document.getElementById('new-featured').checked,
                tags: document.getElementById('new-tags').value.split(',').map(t => t.trim()).filter(t => t),
                external: document.getElementById('new-external').checked
            };

            // Validation
            if (!newArticle.id || !newArticle.title || !newArticle.path) {
                alert('ID, ì œëª©, ê²½ë¡œëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
                return;
            }

            // Check for duplicate ID
            if (articlesData.articles.some(a => a.id === newArticle.id)) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” IDì…ë‹ˆë‹¤. ë‹¤ë¥¸ IDë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.');
                return;
            }

            articlesData.articles.push(newArticle);
            hasUnsavedChanges = true;

            // Reload unregistered files to remove the newly registered one
            loadUnregisteredFiles().then(() => {
                renderTable();
                updateStats();
            });

            hideAddArticleForm();
            alert('ìƒˆ ê¸°ì‚¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. "ë³€ê²½ì‚¬í•­ ì €ì¥" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì €ì¥í•˜ì„¸ìš”.');
        }

        function registerFile(path) {
            // Get metadata from cache
            const metadata = htmlMetadataCache[path] || {};

            // Pre-fill the form with extracted metadata
            showAddArticleForm();

            // Generate ID from path
            const filename = path.split('/').pop().replace('.html', '');
            const suggestedId = filename.replace(/[^a-zA-Z0-9-]/g, '-').toLowerCase();

            document.getElementById('new-id').value = suggestedId;
            document.getElementById('new-title').value = metadata.title || '';
            document.getElementById('new-description').value = metadata.description || '';
            document.getElementById('new-path').value = path;
            document.getElementById('new-image').value = metadata.image || 'https://blog.pebblous.ai/image/Pebblous_BM_Orange_RGB.png';
            document.getElementById('new-date').valueAsDate = new Date();
            document.getElementById('new-published').checked = false; // Default to unpublished
            document.getElementById('new-featured').checked = false;

            // Parse keywords as tags if available
            if (metadata.keywords) {
                document.getElementById('new-tags').value = metadata.keywords;
            }

            // Scroll to form
            document.getElementById('add-article-form').scrollIntoView({ behavior: 'smooth' });
        }

        function saveChanges() {
            if (!hasUnsavedChanges) {
                alert('ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const jsonString = JSON.stringify(articlesData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'articles.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('ë³€ê²½ì‚¬í•­ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\n\në‹¤ìš´ë¡œë“œëœ articles.json íŒŒì¼ì„ repo rootì— ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
            hasUnsavedChanges = false;
        }

        function exportJSON() {
            const jsonString = JSON.stringify(articlesData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'articles.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function refreshData() {
            if (hasUnsavedChanges) {
                if (!confirm('ì €ì¥ë˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
            }
            hasUnsavedChanges = false;
            loadArticles();
        }

        // Warn on page unload with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // ============================================================
        // Authentication System
        // ============================================================

        const SESSION_KEY = 'pebblous_admin_session';
        const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 hours

        // SHA-256 hash of your password
        // You can change this by generating a new hash at https://emn178.github.io/online-tools/sha256.html
        const PASSWORD_HASH = '29b3c035e215d144ade00c46a4a08ca21fc1e4d3ffa2387d228eef1e005afb57';

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        async function handleLogin(event) {
            event.preventDefault();
            const passwordInput = document.getElementById('password');
            const password = passwordInput.value;
            const errorEl = document.getElementById('login-error');

            const hash = await sha256(password);

            if (hash === PASSWORD_HASH) {
                // Store session with timestamp
                const session = {
                    timestamp: Date.now(),
                    authenticated: true
                };
                localStorage.setItem(SESSION_KEY, JSON.stringify(session));

                // Show admin content
                showAdminContent();
                errorEl.classList.add('hidden');
            } else {
                errorEl.classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }

            return false;
        }

        function checkSession() {
            const sessionData = localStorage.getItem(SESSION_KEY);

            if (!sessionData) {
                return false;
            }

            try {
                const session = JSON.parse(sessionData);
                const now = Date.now();
                const elapsed = now - session.timestamp;

                // Check if session is still valid (within 24 hours)
                if (elapsed < SESSION_DURATION && session.authenticated) {
                    return true;
                }

                // Session expired
                localStorage.removeItem(SESSION_KEY);
                return false;
            } catch (e) {
                localStorage.removeItem(SESSION_KEY);
                return false;
            }
        }

        function showAdminContent() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-content').classList.add('authenticated');
            loadArticles();
            setupFilters();
        }

        function logout() {
            if (hasUnsavedChanges) {
                if (!confirm('ì €ì¥ë˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
            }
            localStorage.removeItem(SESSION_KEY);
            window.location.reload();
        }

        // Check session on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (checkSession()) {
                showAdminContent();
            }
        });
    </script>
</body>
</html>
