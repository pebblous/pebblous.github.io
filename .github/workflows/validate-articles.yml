name: Validate Articles

on:
  push:
    paths:
      - 'articles.json'
  pull_request:
    paths:
      - 'articles.json'

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate JSON syntax
        run: |
          echo "Validating articles.json syntax..."
          if ! jq empty articles.json 2>/dev/null; then
            echo "‚ùå Invalid JSON syntax in articles.json"
            exit 1
          fi
          echo "‚úÖ JSON syntax is valid"

      - name: Validate articles schema
        run: |
          echo "Validating articles schema..."

          # Check required top-level keys
          if ! jq -e '.articles' articles.json > /dev/null; then
            echo "‚ùå Missing 'articles' array"
            exit 1
          fi

          if ! jq -e '.categories' articles.json > /dev/null; then
            echo "‚ùå Missing 'categories' object"
            exit 1
          fi

          # Check each article has required fields
          jq -r '.articles[] | select(.id == null or .title == null or .category == null or .date == null or .path == null) | .id // "unknown"' articles.json > /tmp/invalid_articles.txt

          if [ -s /tmp/invalid_articles.txt ]; then
            echo "‚ùå Found articles with missing required fields:"
            cat /tmp/invalid_articles.txt
            exit 1
          fi

          echo "‚úÖ All articles have required fields"

      - name: Check for duplicate IDs
        run: |
          echo "Checking for duplicate article IDs..."

          duplicates=$(jq -r '.articles[].id' articles.json | sort | uniq -d)

          if [ -n "$duplicates" ]; then
            echo "‚ùå Found duplicate article IDs:"
            echo "$duplicates"
            exit 1
          fi

          echo "‚úÖ No duplicate IDs found"

      - name: Validate dates
        run: |
          echo "Validating article dates..."

          invalid_dates=$(jq -r '.articles[] | select(.date | . == null or (. | test("^[0-9]{4}-[0-9]{2}-[0-9]{2}$") | not)) | .id' articles.json)

          if [ -n "$invalid_dates" ]; then
            echo "‚ùå Found articles with invalid date format (should be YYYY-MM-DD):"
            echo "$invalid_dates"
            exit 1
          fi

          echo "‚úÖ All dates are valid"

      - name: Validate categories
        run: |
          echo "Validating article categories..."

          # Get defined categories
          defined_categories=$(jq -r '.categories | keys[]' articles.json)

          # Check if all article categories are defined
          for category in $(jq -r '.articles[].category' articles.json | sort -u); do
            if ! echo "$defined_categories" | grep -q "^${category}$"; then
              echo "‚ùå Article category '$category' is not defined in categories object"
              exit 1
            fi
          done

          echo "‚úÖ All article categories are valid"

      - name: Summary
        if: success()
        run: |
          total=$(jq '.articles | length' articles.json)
          published=$(jq '[.articles[] | select(.published == true)] | length' articles.json)
          featured=$(jq '[.articles[] | select(.featured == true)] | length' articles.json)

          echo "üìä Validation Summary:"
          echo "  Total articles: $total"
          echo "  Published: $published"
          echo "  Featured: $featured"
          echo ""
          echo "‚úÖ All validations passed!"
